<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ethnic Progress Bar</title>
  <link
    href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700;900&family=DM+Sans:wght@300;400;500&display=swap"
    rel="stylesheet">
  <style>
    /* ═══════════════════════════════════════
   BASE
═══════════════════════════════════════ */
    *,
    *::before,
    *::after {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --bg: #0a0a0a;
      --s1: #141414;
      --s2: #1f1f1f;
      --s3: #2a2a2a;
      --gold: #c8962a;
      --goldl: #ffcc66;
      --cream: #ffffff;
      --text: #e0e0e0;
      --muted: #a0a0a0;
      --b1: rgba(255, 255, 255, 0.08);
      --b2: rgba(255, 255, 255, 0.04);
      --nav-h: 46px;
    }

    html,
    body {
      width: 100%;
      height: 100%;
      overflow: hidden;
      background: var(--bg);
      color: var(--text);
      font-family: 'DM Sans', sans-serif;
      font-size: 15px;
      /* Base font increased */
      display: flex;
      flex-direction: column;
    }

    /* ═══════════════════════════════════════
   NAV
═══════════════════════════════════════ */
    .nav {
      height: var(--nav-h);
      flex-shrink: 0;
      background: rgba(7, 9, 14, 0.96);
      backdrop-filter: blur(12px);
      border-bottom: 1px solid var(--b1);
      display: flex;
      align-items: center;
      gap: 0.9rem;
      padding: 0 1.4rem;
      z-index: 300;
    }

    .nav-logo {
      font-family: 'Playfair Display', serif;
      font-size: 0.95rem;
      font-weight: 700;
      color: var(--gold);
      text-decoration: none;
    }

    .nav-div {
      width: 1px;
      height: 14px;
      background: var(--b1);
    }

    .nav-hint {
      font-size: 0.7rem;
      color: var(--muted);
    }

    .nav-back {
      margin-left: auto;
      font-size: 0.7rem;
      color: var(--muted);
      text-decoration: none;
      padding: 0.25rem 0.65rem;
      border: 1px solid var(--b1);
      transition: all .18s;
    }

    .nav-back:hover {
      color: var(--gold);
      border-color: var(--gold);
    }

    /* ═══════════════════════════════════════
   APP SHELL
═══════════════════════════════════════ */
    .app {
      flex: 1;
      min-height: 0;
      display: flex;
    }

    /* ═══════════════════════════════════════
   SIDEBAR
═══════════════════════════════════════ */
    .sb {
      width: 340px;
      flex-shrink: 0;
      /* Width increased from 256px */
      background: var(--s1);
      border-right: 1px solid var(--b1);
      display: flex;
      flex-direction: column;
      overflow-y: auto;
      overflow-x: hidden;
    }

    .sb::-webkit-scrollbar {
      width: 3px;
    }

    .sb::-webkit-scrollbar-thumb {
      background: rgba(200, 150, 42, 0.18);
      border-radius: 2px;
    }

    /* ── Brand ── */
    .sb-brand {
      padding: 1.8rem 1.5rem 1.4rem;
      border-bottom: 1px solid rgba(255, 255, 255, 0.06);
      background: linear-gradient(180deg, var(--s2) 0%, var(--s1) 100%);
    }

    .sb-brand-title {
      font-family: 'Playfair Display', serif;
      font-size: 1.4rem;
      font-weight: 900;
      color: var(--cream);
      line-height: 1;
    }

    .sb-brand-title em {
      color: var(--gold);
      font-style: normal;
    }

    .sb-brand-sub {
      font-size: 0.85rem;
      color: var(--muted);
      margin-top: 0.6rem;
      line-height: 1.6;
      font-weight: 300;
    }

    /* ── Generic section ── */
    .sb-sec {
      border-bottom: 1px solid rgba(255, 255, 255, 0.06);
      padding: 1.4rem 1.5rem;
    }

    .sb-sec:last-child {
      border-bottom: none;
    }

    .sb-lbl {
      font-size: 0.7rem;
      letter-spacing: 0.18em;
      text-transform: uppercase;
      color: var(--gold);
      margin-bottom: 0.85rem;
      font-weight: 600;
      opacity: 0.9;
    }

    /* ── View tabs ── */
    .vtabs {
      display: flex;
      flex-direction: column;
      gap: 0.2rem;
    }

    .vt {
      display: flex;
      align-items: center;
      gap: 0.55rem;
      padding: 0.65rem 0.85rem;
      border: 1px solid var(--b2);
      background: transparent;
      color: var(--muted);
      font-family: 'DM Sans', sans-serif;
      font-size: 0.85rem;
      cursor: pointer;
      transition: all .15s;
      text-align: left;
      width: 100%;
    }

    .vt-icon {
      font-size: 1rem;
      flex-shrink: 0;
    }

    .vt.on {
      background: var(--s3);
      border-color: var(--gold);
      color: var(--cream);
    }

    .vt:hover:not(.on) {
      border-color: rgba(200, 150, 42, 0.35);
      color: var(--text);
    }

    .vt-desc {
      margin-top: 0.5rem;
      padding: 0.65rem 0.85rem;
      background: var(--s2);
      border-left: 2px solid var(--gold);
      font-size: 0.8rem;
      color: var(--muted);
      line-height: 1.6;
    }

    /* ── Filter chips ── */
    .chips {
      display: flex;
      flex-direction: column;
      gap: 0.18rem;
    }

    .ch {
      padding: 0.55rem 0.85rem;
      font-size: 0.85rem;
      border: 1px solid var(--b2);
      background: transparent;
      color: var(--muted);
      cursor: pointer;
      transition: all .15s;
      font-family: 'DM Sans', sans-serif;
      text-align: left;
      width: 100%;
    }

    .ch.on {
      background: rgba(200, 150, 42, 0.1);
      border-color: var(--gold);
      color: var(--goldl);
      font-weight: 500;
    }

    .ch:hover:not(.on) {
      border-color: rgba(200, 150, 42, 0.3);
      color: var(--text);
    }

    /* ── Select dropdowns ── */
    .sb-ctls {
      display: flex;
      flex-direction: column;
      gap: 0.4rem;
    }

    .sb-ctl {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }

    .sb-ctl-lbl {
      font-size: 0.65rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--muted);
    }

    .sw {
      position: relative;
    }

    .sw select {
      appearance: none;
      width: 100%;
      background: var(--bg);
      border: 1px solid var(--b2);
      color: var(--text);
      font-family: 'DM Sans', sans-serif;
      font-size: 0.8rem;
      padding: 0.4rem 1.6rem 0.4rem 0.6rem;
      cursor: pointer;
      outline: none;
    }

    .sw select:hover {
      border-color: rgba(200, 150, 42, 0.35);
    }

    .sw::after {
      content: '▾';
      position: absolute;
      right: 0.4rem;
      top: 50%;
      transform: translateY(-50%);
      color: var(--gold);
      font-size: 0.6rem;
      pointer-events: none;
    }

    /* ── Score inputs ── */
    .sc-in {
      background: rgba(255, 255, 255, 0.04);
      border: 1px solid rgba(255, 255, 255, 0.08);
      color: var(--gold);
      border-radius: 4px;
      padding: 0.5rem;
      width: 60px;
      text-align: center;
      font-family: 'DM Sans', sans-serif;
      font-size: 0.85rem;
      transition: all 0.2s;
    }

    .sc-in:focus {
      border-color: var(--gold);
      outline: none;
      background: rgba(200, 150, 42, 0.08);
    }

    .sc-in::-webkit-inner-spin-button,
    .sc-in::-webkit-outer-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }

    /* ── Context Box ── */
    .m-ctx {
      margin-bottom: 1.4rem;
      padding: 1rem 1.2rem;
      background: rgba(200, 150, 42, 0.05);
      border-left: 4px solid var(--muted);
      font-style: italic;
      color: var(--text);
      font-size: 0.9rem;
      line-height: 1.6;
    }

    .m-ctx-t {
      font-size: 0.7rem;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: var(--muted);
      margin-bottom: 0.4rem;
      font-style: normal;
    }

    /* ── Legend ── */
    .leg-grid {
      display: flex;
      flex-direction: column;
      gap: 0.4rem;
    }

    .leg-row {
      display: flex;
      align-items: center;
      gap: 0.6rem;
      font-size: 0.8rem;
    }

    .leg-dot {
      width: 8px;
      height: 8px;
      border-radius: 1px;
      flex-shrink: 0;
    }

    .leg-name {
      flex: 1;
      color: var(--text);
    }

    .leg-bar {
      width: 50px;
      height: 3px;
      background: var(--b2);
      border-radius: 1px;
      overflow: hidden;
      flex-shrink: 0;
    }

    .leg-bar-f {
      height: 100%;
      border-radius: 1px;
    }

    .leg-pts {
      font-size: 0.7rem;
      color: var(--gold);
      min-width: 38px;
      text-align: right;
      opacity: 0.8;
    }

    /* ── Methodology accordion ── */
    .meth-hdr {
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: none;
      border: none;
      padding: 0;
      font-family: 'DM Sans', sans-serif;
      font-size: 0.8rem;
      color: var(--muted);
      cursor: pointer;
      transition: color .15s;
    }

    .meth-hdr:hover {
      color: var(--gold);
    }

    .meth-arr {
      font-size: 0.58rem;
      transition: transform .22s;
      display: inline-block;
    }

    .meth-hdr.on .meth-arr {
      transform: rotate(90deg);
    }

    .meth-body {
      overflow: hidden;
      max-height: 0;
      transition: max-height .35s ease;
    }

    .meth-body.on {
      max-height: 1200px;
    }

    .meth-inner {
      margin-top: 0.6rem;
      display: flex;
      flex-direction: column;
      gap: 0.35rem;
    }

    .meth-group-title {
      font-size: 0.57rem;
      letter-spacing: 0.15em;
      text-transform: uppercase;
      color: var(--gold);
      padding-top: 0.45rem;
      margin-top: 0.1rem;
      border-top: 1px solid var(--b2);
    }

    .meth-group-title:first-child {
      border-top: none;
      padding-top: 0;
      margin-top: 0;
    }

    .meth-dim {
      background: var(--bg);
      border: 1px solid var(--b2);
      padding: 0.38rem 0.5rem;
    }

    .meth-dim-t {
      font-size: 0.6rem;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      color: var(--gold);
      margin-bottom: 0.12rem;
    }

    .meth-dim p {
      font-size: 0.65rem;
      color: var(--muted);
      line-height: 1.5;
    }

    .meth-eq {
      padding: 0.4rem 0.55rem;
      background: var(--bg);
      border-left: 2px solid var(--gold);
      font-size: 0.65rem;
      color: var(--text);
      line-height: 1.6;
      margin-top: 0.2rem;
    }

    .meth-eq strong {
      color: var(--gold);
    }

    .meth-note {
      font-size: 0.62rem;
      color: var(--muted);
      font-style: italic;
      line-height: 1.5;
      margin-top: 0.2rem;
    }

    /* ═══════════════════════════════════════
   MAIN + CHART
═══════════════════════════════════════ */
    .main {
      flex: 1;
      min-width: 0;
      min-height: 0;
      display: flex;
      flex-direction: column;
      padding: 0.9rem 1.1rem;
      gap: 0;
      overflow: hidden;
    }

    .chart-shell {
      flex: 1;
      min-height: 0;
      background: var(--s1);
      border: 1px solid var(--b1);
      display: flex;
      flex-direction: column;
      position: relative;
      overflow: hidden;
    }

    /* Rotated Y label */
    .y-vert {
      position: absolute;
      left: 0.35rem;
      top: 50%;
      writing-mode: vertical-lr;
      transform: rotate(180deg) translateY(50%);
      font-size: 0.55rem;
      letter-spacing: 0.15em;
      text-transform: uppercase;
      color: var(--muted);
      white-space: nowrap;
      pointer-events: none;
      z-index: 2;
    }

    /* inner flex: y-axis col + plot area */
    .c-layout {
      display: flex;
      padding: 0.85rem 0.9rem 0 2.5rem;
      min-height: 0;
      flex-shrink: 0;
    }

    .y-col {
      width: 40px;
      flex-shrink: 0;
      position: relative;
    }

    .plot {
      flex: 1;
      position: relative;
      min-width: 0;
      overflow: hidden;
    }

    /* Y ticks */
    .ytick {
      position: absolute;
      right: 0;
      display: flex;
      align-items: center;
      gap: 3px;
      transform: translateY(50%);
    }

    .ytick-lbl {
      font-size: 0.57rem;
      color: var(--muted);
      white-space: nowrap;
    }

    .ytick-mk {
      width: 4px;
      height: 1px;
      background: rgba(200, 150, 42, 0.3);
    }

    /* Grid */
    .hgl {
      position: absolute;
      left: 0;
      right: 0;
      height: 1px;
      background: var(--b2);
      pointer-events: none;
    }

    .base {
      position: absolute;
      left: 0;
      right: 0;
      bottom: 0;
      height: 2px;
      background: rgba(200, 150, 42, 0.35);
      z-index: 3;
    }

    /* ── grouped bars ── */
    .bars {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: flex-end;
      gap: 5px;
      padding: 0 2px;
    }

    .bgrp {
      flex: 1;
      min-width: 0;
      height: 100%;
      display: flex;
      align-items: flex-end;
    }

    .bstk {
      width: 100%;
      display: flex;
      flex-direction: column-reverse;
      overflow: hidden;
    }

    .bseg {
      width: 100%;
      flex-shrink: 0;
      cursor: pointer;
      transition: filter .13s;
      border-top: 1px solid rgba(0, 0, 0, 0.14);
    }

    .bseg:hover {
      filter: brightness(1.35);
      position: relative;
      z-index: 8;
    }

    .bseg:last-child {
      border-top-left-radius: 2px;
      border-top-right-radius: 2px;
    }

    /* ── timeline bars ── */
    .tl-canvas {
      position: absolute;
      inset: 0;
      overflow: hidden;
    }

    .tl-bar {
      position: absolute;
      bottom: 0;
      z-index: 2;
      cursor: pointer;
      border-top-left-radius: 2px;
      border-top-right-radius: 2px;
      transition: filter .13s;
    }

    .tl-bar:hover {
      filter: brightness(1.35);
      z-index: 10;
    }

    .tl-era {
      position: absolute;
      bottom: 0;
      top: 0;
      width: 1px;
      background: rgba(200, 150, 42, 0.1);
      pointer-events: none;
    }

    .tl-era-l {
      position: absolute;
      font-size: 0.54rem;
      color: rgba(82, 92, 110, 0.5);
      transform: translateX(-50%);
      white-space: nowrap;
      pointer-events: none;
    }

    /* ── x/labels strip ── */
    .x-strip {
      flex-shrink: 0;
      border-top: 1px solid rgba(200, 150, 42, 0.2);
      background: var(--s1);
    }

    /* grouped labels */
    .glabels {
      display: flex;
      gap: 5px;
      padding: 0.38rem 0.9rem 0.55rem calc(2.5rem + 40px + 2px);
    }

    .glbl {
      flex: 1;
      min-width: 0;
      text-align: center;
    }

    .glbl-n {
      font-size: 0.63rem;
      color: var(--text);
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .glbl-m {
      font-size: 0.55rem;
      color: var(--muted);
      margin-top: 0.12rem;
    }

    /* timeline info */
    .tlinfo {
      padding: 0.38rem 0.9rem 0.55rem calc(2.5rem + 40px + 6px);
      font-size: 0.6rem;
      color: var(--muted);
    }

    /* ═══════════════════════════════════════
   TOOLTIP
═══════════════════════════════════════ */
    .tt {
      position: fixed;
      z-index: 9000;
      background: var(--s2);
      border: 1px solid rgba(200, 150, 42, 0.4);
      padding: 0.95rem 1.1rem;
      max-width: 320px;
      min-width: 240px;
      pointer-events: none;
      opacity: 0;
      transform: translateY(4px);
      transition: opacity .1s, transform .1s;
      box-shadow: 0 10px 35px rgba(0, 0, 0, 0.65);
    }

    .tt.on {
      opacity: 1;
      transform: translateY(0);
    }

    .tt-yr {
      font-size: 0.7rem;
      letter-spacing: 0.14em;
      color: var(--gold);
      text-transform: uppercase;
      margin-bottom: 0.25rem;
    }

    .tt-nm {
      font-family: 'Playfair Display', serif;
      font-size: 1.1rem;
      color: var(--cream);
      margin-bottom: 0.3rem;
      line-height: 1.2;
    }

    .tt-grp {
      font-size: 0.75rem;
      margin-bottom: 0.3rem;
    }

    .tt-cat {
      font-size: 0.75rem;
      color: var(--muted);
      margin-bottom: 0.5rem;
    }

    .tt-dsc {
      font-size: 0.85rem;
      color: var(--muted);
      line-height: 1.6;
    }

    .tt-row {
      display: flex;
      align-items: center;
      gap: 0.38rem;
      margin-top: 0.55rem;
    }

    .tt-rl {
      font-size: 0.6rem;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.07em;
    }

    .tt-rb {
      flex: 1;
      height: 2.5px;
      background: rgba(200, 150, 42, 0.1);
      border-radius: 2px;
      overflow: hidden;
    }

    .tt-rf {
      height: 100%;
      border-radius: 2px;
    }

    .tt-rn {
      font-size: 0.7rem;
      color: var(--gold);
      font-weight: 500;
      min-width: 22px;
      text-align: right;
    }

    .tt-hint {
      margin-top: 0.38rem;
      font-size: 0.6rem;
      color: rgba(82, 92, 110, 0.5);
      font-style: italic;
    }

    /* ═══════════════════════════════════════
   MODAL
═══════════════════════════════════════ */
    .modal-bg {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.85);
      z-index: 600;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 1.5rem;
      opacity: 0;
      pointer-events: none;
      transition: opacity .22s;
      backdrop-filter: blur(5px);
    }

    .modal-bg.on {
      opacity: 1;
      pointer-events: all;
    }

    .modal {
      background: var(--s1);
      border: 1px solid rgba(200, 150, 42, 0.28);
      max-width: 720px;
      width: 100%;
      max-height: 88vh;
      overflow-y: auto;
      padding: 1.75rem;
      position: relative;
      transform: scale(0.96) translateY(12px);
      transition: transform .22s;
    }

    .modal-bg.on .modal {
      transform: scale(1) translateY(0);
    }

    .modal-x {
      position: absolute;
      top: 1rem;
      right: 1rem;
      background: none;
      border: none;
      color: var(--muted);
      font-size: 1.4rem;
      cursor: pointer;
      padding: 0.4rem;
    }

    .modal-x:hover {
      color: var(--cream);
    }

    .m-cat {
      font-size: 0.75rem;
      letter-spacing: 0.2em;
      text-transform: uppercase;
      color: var(--gold);
      margin-bottom: 0.5rem;
    }

    .m-h {
      font-family: 'Playfair Display', serif;
      font-size: 1.9rem;
      font-weight: 700;
      color: var(--cream);
      margin-bottom: 0.6rem;
    }

    .m-meta {
      font-size: 0.9rem;
      color: var(--muted);
      margin-bottom: 1.4rem;
      display: flex;
      gap: 1.2rem;
      flex-wrap: wrap;
    }

    .m-imp {
      background: var(--bg);
      padding: 1rem 1.2rem;
      margin-bottom: 1.2rem;
      border-left: 4px solid var(--gold);
    }

    .m-imp-t {
      font-size: 0.7rem;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: var(--gold);
      margin-bottom: 0.4rem;
    }

    .m-imp p {
      font-size: 0.95rem;
      color: var(--text);
      line-height: 1.7;
    }

    .m-body {
      font-size: 0.95rem;
      color: var(--muted);
      line-height: 1.8;
    }

    .m-sc {
      margin-top: 1.5rem;
      padding-top: 1.5rem;
      border-top: 1px solid var(--b1);
    }

    .m-sc-t {
      font-size: 0.7rem;
      letter-spacing: 0.14em;
      text-transform: uppercase;
      color: var(--gold);
      margin-bottom: 0.8rem;
    }

    .m-row {
      display: flex;
      align-items: center;
      gap: 0.85rem;
      margin-bottom: 0.5rem;
    }

    .m-rl {
      font-size: 0.85rem;
      color: var(--muted);
      width: 180px;
      flex-shrink: 0;
    }

    .m-rb {
      flex: 1;
      height: 6px;
      background: rgba(200, 150, 42, 0.09);
      border-radius: 3px;
      overflow: hidden;
    }

    .m-rf {
      height: 100%;
      border-radius: 3px;
    }

    .m-rn {
      font-size: 0.85rem;
      color: var(--text);
      min-width: 40px;
      text-align: right;
    }

    .m-tot {
      display: flex;
      justify-content: space-between;
      margin-top: 0.65rem;
      padding-top: 0.65rem;
      border-top: 1px solid var(--b2);
    }

    .m-tot-l {
      font-size: 0.76rem;
      color: var(--cream);
    }

    .m-tot-n {
      font-size: 0.86rem;
      color: var(--gold);
      font-weight: 600;
    }

    ::-webkit-scrollbar {
      width: 3px;
      height: 3px;
    }

    ::-webkit-scrollbar-track {
      background: var(--bg);
    }

    ::-webkit-scrollbar-thumb {
      background: rgba(200, 150, 42, 0.2);
      border-radius: 2px;
    }

    .leg-mode {
      display: flex;
      gap: 1px;
      background: var(--b2);
      border: 1px solid var(--b2);
      border-radius: 4px;
      overflow: hidden;
      margin-bottom: 0.8rem;
    }

    .leg-btn {
      flex: 1;
      background: var(--s2);
      border: none;
      color: var(--muted);
      font-family: inherit;
      font-size: 0.75rem;
      padding: 0.4rem;
      cursor: pointer;
      transition: all 0.2s;
    }

    .leg-btn:hover {
      background: var(--s3);
      color: var(--fg);
    }

    .leg-btn.on {
      background: var(--fg);
      color: var(--bg);
      font-weight: 500;
    }
  </style>
</head>

<body>

  <!-- NAV -->
  <nav class="nav">
    <a class="nav-logo" href="index.html">EPB</a>
    <div class="nav-div"></div>
    <span class="nav-hint">Ethnic Progress Bar · Visualization</span>
    <a class="nav-back" href="index.html">← Back</a>
  </nav>

  <!-- APP SHELL -->
  <div class="app">

    <!-- SIDEBAR -->
    <aside class="sb">

      <div class="sb-brand">
        <div class="sb-brand-title">Ethnic <em>Progress Bar</em></div>
        <div class="sb-brand-sub">Significant contributions to humanity – visualized by impact &amp; origin.
        </div>
      </div>

      <!-- Top Bar -->
      <div class="top-bar">
        <div class="d-tabs" id="dtabs">
          <button class="vt on" data-d="inv">Inventions</button>
          <button class="vt" data-d="nobel">Nobel Prizes</button>
        </div>
      </div>

      <!-- Controls -->
      <div class="sb-sec">
        <div class="sb-lbl">View</div>
        <div class="view-toggles" id="vtabs">
          <button class="vt on" data-v="grouped">Groups</button>
          <button class="vt" data-v="timeline">Timeline</button>
          <button class="vt" data-v="revolution">Revolution</button>
        </div>
        <div class="vt-desc" id="vtDesc">Compare contributions by culture group.</div>
      </div>

      <div class="sb-sec">
        <div class="sb-lbl">Categories</div>
        <div class="chips" id="chips">
          <button class="ch on" data-c="all">All</button>
          <!-- Chips will be injected by JS -->
        </div>
      </div>

      <!-- Sort (grouped only) -->
      <div class="sb-sec" id="sortSec">
        <div class="sb-lbl">Sort</div>
        <div class="sb-ctls">
          <div class="sb-ctl"><span class="sb-ctl-lbl">Sort By</span>
            <div class="sw"><select id="sortSel">
                <option value="score">Total Impact</option>
                <option value="count">Count (Low → High)</option>
                <option value="count_desc">Count (High → Low)</option>
                <option value="alpha">Alphabetical</option>
                <option value="oldest">Oldest Item</option>
              </select></div>
          </div>
        </div>
      </div>

      <!-- Score Range (always visible) -->
      <div class="sb-sec">
        <div class="sb-lbl">Score Range</div>
        <div class="sb-ctls">
          <div class="sb-ctl"><span class="sb-ctl-lbl">Impact Score</span>
            <div class="range-inputs">
              <input type="number" id="minScoreInp" placeholder="Min" value="0" min="0" max="100" class="sc-in">
              <span>–</span>
              <input type="number" id="maxScoreInp" placeholder="Max" value="100" min="0" max="100" class="sc-in">
            </div>
          </div>
        </div>
      </div>

      <!-- Legend -->
      <div class="sb-sec">
        <div class="sb-lbl">Culture Groups</div>
        <div class="leg-mode" id="legMode">
          <button class="leg-btn on" data-lm="total">∑ Total</button>
          <button class="leg-btn" data-lm="avg">⌀ Average</button>
        </div>
        <div class="leg-grid" id="legGrid"></div>
      </div>

      <!-- Methodology -->
      <div class="sb-sec">
        <button class="meth-hdr" id="methHdr">
          <span>ℹ️ Methodology</span>
          <span class="meth-arr">▶</span>
        </button>
        <div class="meth-body" id="methBody">
          <div class="meth-inner">
            <!-- Content injected by JS -->
          </div>
        </div>
      </div>

    </aside>

    <!-- MAIN CHART AREA -->
    <main class="main" id="mainEl">
      <div class="chart-shell" id="shell">
        <div class="y-vert" id="yLbl">Societal Impact</div>
        <!-- chart body injected here by JS -->
        <div id="cBody" style="flex:1;min-height:0;display:flex;flex-direction:column;"></div>
        <div class="x-strip" id="xStrip"></div>
      </div>
    </main>

  </div>

  <!-- TOOLTIP -->
  <div class="tt" id="tt">
    <div class="tt-yr" id="ttYr"></div>
    <div class="tt-nm" id="ttNm"></div>
    <div class="tt-grp" id="ttGrp"></div>
    <div class="tt-cat" id="ttCat"></div>
    <div class="tt-dsc" id="ttDsc"></div>
    <div class="tt-row">
      <span class="tt-rl" id="ttRl">Score</span>
      <div class="tt-rb">
        <div class="tt-rf" id="ttRf"></div>
      </div>
      <span class="tt-rn" id="ttRn"></span>
    </div>
    <div class="tt-hint">Click for details ↗</div>
  </div>

  <!-- MODAL -->
  <div class="modal-bg" id="modalBg">
    <div class="modal">
      <button class="modal-x" id="modalX">✕</button>
      <div class="m-cat" id="mCat"></div>
      <h2 class="m-h" id="mH"></h2>
      <div class="m-meta" id="mMeta"></div>
      <div class="m-imp">
        <div class="m-imp-t">Societal Impact</div>
        <p id="mImp"></p>
      </div>
      <div class="m-ctx">
        <div class="m-ctx-t">Historical Context</div>
        <p id="mCtx"></p>
      </div>
      <div class="m-body" id="mBody"></div>
      <div class="m-sc">
        <div class="m-sc-t">Score Breakdown</div>
        <div id="mRows"></div>
        <div class="m-tot"><span class="m-tot-l" id="mTotL">Total</span><span class="m-tot-n" id="mTot"></span></div>
      </div>
    </div>
  </div>

  <script src="nobel_data.js"></script>
  <script>
    // ══════════════════════════════════════
    // DATA
    // ══════════════════════════════════════
    const GRP = [
      { id: 'europa', name: 'Europe', col: '#c8962a' },
      { id: 'ostasien', name: 'East Asia', col: '#4a7fb5' },
      { id: 'nahost', name: 'Middle East / MENA', col: '#6faa55' },
      { id: 'suedasien', name: 'South Asia', col: '#c05a4a' },
      { id: 'mesopo', name: 'Mesopotamia / Antiquity', col: '#c9853a' },
      { id: 'afrika', name: 'Africa', col: '#4aab9a' },
      { id: 'amerika', name: 'Americas', col: '#7a5ab5' },
      { id: 'ozeanien', name: 'Oceania', col: '#008080' },
    ];
    const GM = Object.fromEntries(GRP.map(g => [g.id, g]));

    // Fields: g=group, n=name, y=year, c=cat
    // Score A: reach(0-25)+dur(0-25)+mult(0-30)+qual(0-20) = 100
    // Score B: cbrk(0-40)+imm(0-30)+shk(0-30) = 100
    const INV = [
      // MESOPOTAMIEN
      {
        g: 'mesopo', n: 'Agriculture', y: -10000, c: 'Infrastructure', reach: 25, dur: 25, mult: 30, qual: 20, cbrk: 40, imm: 30, shk: 28, inv: 'Early Farmers', org: 'Middle East',
        dsc: 'Transition from hunter-gatherers to sedentary agriculture.',
        imp: 'Basis of all civilization. Enabled surplus, cities, and specialization.',
        ctx: 'In the fertile crescent, people began cultivating wild grasses (emmer, einkorn). This ended 200,000 years of nomadism. For the first time, humans could store food, which led to population explosion but also to property, war, and hierarchies.'
      },
      {
        g: 'mesopo', n: 'Irrigation / Canal Construction', y: -6000, c: 'Infrastructure', reach: 19, dur: 20, mult: 18, qual: 16, cbrk: 28, imm: 26, shk: 18, inv: 'Sumerians', org: 'Iraq',
        dsc: 'Extensive irrigation systems laid the foundation for urban civilization.',
        imp: 'Enabled surplus production, city growth, and division of labor.',
        ctx: 'In dry southern Mesopotamia, agriculture was impossible without artificial irrigation. The Sumerians dug complex canal systems to divert water from the Euphrates and Tigris to the fields. This required central planning and administration, fostering the emergence of the first early state structures.'
      },
      {
        g: 'mesopo', n: 'Wheel', y: -3500, c: 'Physics & Tech', reach: 23, dur: 25, mult: 26, qual: 18, cbrk: 36, imm: 28, shk: 22, inv: 'Unknown', org: 'Mesopotamia / Sumer',
        dsc: 'The wheel (~3500 BC) – first potter\'s wheel, then vehicle wheel.',
        imp: 'Basis of all vehicles and rotating mechanisms. Revolutionized transport and warfare.',
        ctx: 'The wheel was initially invented not for transport, but as a potter\'s wheel. Centuries later, people mounted wheels on axles for carts. This innovation revolutionized the transport of goods and later, with the chariot, also warfare.'
      },
      {
        g: 'mesopo', n: 'Writing (Cuneiform)', y: -3200, c: 'Communication', reach: 23, dur: 25, mult: 29, qual: 18, cbrk: 40, imm: 24, shk: 30, inv: 'Sumerians', org: 'Iraq (Uruk)',
        dsc: 'Sumerian cuneiform (~3200 BC) – oldest known writing.',
        imp: 'No science, law, or history without writing. Basis of all civilizations.',
        ctx: 'In the growing temple cities like Uruk, managing goods became too complex for memory. Priests developed a system of pictographs, later abstracted and pressed into wet clay with a stylus – the birth of information storage.'
      },
      {
        g: 'mesopo', n: 'Calendar', y: -3000, c: 'Math', reach: 22, dur: 25, mult: 16, qual: 15, cbrk: 30, imm: 22, shk: 20, inv: 'Babylonian Astronomers', org: 'Iraq',
        dsc: 'Mesopotamian astronomers developed precise lunisolar calendars.',
        imp: 'Enabled agricultural planning and coordinated social life.',
        ctx: 'To coordinate sowing and harvesting as well as religious festivals, Babylonian priests systematically observed the night sky. They divided the year into 12 lunar months and added leap months to stay in sync with the solar year – a feat requiring deep mathematical knowledge.'
      },
      {
        g: 'mesopo', n: 'Legal System (Hammurabi)', y: -1754, c: 'Economy', reach: 18, dur: 24, mult: 20, qual: 16, cbrk: 32, imm: 22, shk: 26, inv: 'King Hammurabi', org: 'Babylonia',
        dsc: 'Code of Hammurabi (~1754 BC) – 282 laws, first codified norms.',
        imp: 'Basis of all modern legal systems. Principles like proportionality.',
        ctx: 'King Hammurabi had his laws chiseled into a massive diorite stele and placed publicly. He established the principle that law should not be arbitrary, but written and (theoretically) visible to all. It regulated everything from trade contracts to family law.'
      },
      // AFRIKA
      {
        g: 'afrika', n: 'Agriculture (Africa)', y: -5000, c: 'Infrastructure', reach: 14, dur: 22, mult: 12, qual: 13, cbrk: 28, imm: 22, shk: 16, inv: 'Sahel Cultures', org: 'Mali / Niger',
        dsc: 'West African cultures domesticated millet and sorghum independently.',
        imp: 'Food basis for West and Central Africa for millennia.',
        ctx: 'Independently of the Near East, humans in the Sahel zone domesticated wild grasses like pearl millet and sorghum. These plants were perfectly adapted to the dry climate and enabled the flourishing of later West African empires like Mali and Songhai.'
      },
      {
        g: 'afrika', n: 'Math (Egypt)', y: -3000, c: 'Math', reach: 18, dur: 20, mult: 18, qual: 13, cbrk: 28, imm: 18, shk: 18, inv: 'Egyptian Scribes', org: 'Egypt',
        dsc: 'Egyptian geometry and fractions for construction and administration.',
        imp: 'Basis of pyramid construction. Heavily influenced Greek mathematics.',
        ctx: 'For state administration and monumental building projects like the pyramids, Egyptians needed practical mathematics. They developed complex methods for area calculation (geometry) and a decimal number system, later studied by Greek scholars like Thales and Pythagoras.'
      },
      {
        g: 'afrika', n: 'Medicine (Egypt)', y: -2700, c: 'Medicine', reach: 15, dur: 18, mult: 14, qual: 14, cbrk: 26, imm: 20, shk: 18, inv: 'Imhotep et al.', org: 'Egypt',
        dsc: 'Papyri document surgical procedures and diagnoses (~2700 BC).',
        imp: 'First documented medical texts. Influenced Greek and Islamic medicine.',
        ctx: 'Egyptian doctors were famous throughout the Mediterranean. The Edwin Smith Papyrus describes rational, almost modern diagnoses and treatments of head injuries and fractures, largely free of magic – an early triumph of observation and experience.'
      },
      {
        g: 'afrika', n: 'Metallurgy (Iron)', y: -1400, c: 'Physics & Tech', reach: 20, dur: 22, mult: 18, qual: 15, cbrk: 30, imm: 24, shk: 20, inv: 'Various Cultures', org: 'Tanzania, Nigeria',
        dsc: 'Sub-Saharan Africa developed iron smelting independently.',
        imp: 'Revolutionized tools, weapons, and agriculture worldwide.',
        ctx: 'In the Nok culture (Nigeria) and the Great Lakes region, smiths developed sophisticated blast furnaces to extract iron – possibly earlier or independently of Europe and the Near East. Iron tools revolutionized agriculture and enabled the settlement of dense rainforests.'
      },

      // OSTASIEN
      {
        g: 'ostasien', n: 'Silk', y: -3000, c: 'Economy', reach: 17, dur: 20, mult: 14, qual: 11, cbrk: 24, imm: 16, shk: 14, inv: 'Leizu (legendary)', org: 'China',
        dsc: 'China developed silk production and established the Silk Road.',
        imp: 'Global trade network, cultural exchange between Asia and Europe.',
        ctx: 'Legend has it that Empress Leizu discovered silk harvesting when a cocoon fell into her tea. For millennia, China guarded the secret of sericulture under penalty of death, making silk the most precious trade good of antiquity and creating the first global trade routes.'
      },
      {
        g: 'ostasien', n: 'Paper', y: -105, c: 'Communication', reach: 25, dur: 25, mult: 27, qual: 17, cbrk: 36, imm: 20, shk: 22, inv: 'Cai Lun', org: 'China',
        dsc: 'Cai Lun developed paper from plant fibers (105 AD).',
        imp: 'Enabled mass dissemination of knowledge via Silk Road.',
        ctx: 'Before paper, people wrote on expensive silk or heavy bamboo strips. Court official Cai Lun standardized a process in 105 AD to scoop a light, cheap writing material from mulberry bark, fishing nets, and rags. This revolutionized the administration of the vast empire.'
      },
      {
        g: 'ostasien', n: 'Porcelain', y: 620, c: 'Economy', reach: 15, dur: 17, mult: 10, qual: 9, cbrk: 18, imm: 14, shk: 12, inv: 'Unknown', org: 'China (Tang Era)',
        dsc: 'Tang Era China perfected porcelain as a major export.',
        imp: 'Globally coveted trade good, influenced European ceramics.',
        ctx: 'By refining kaolin clay and using extremely high firing temperatures, Chinese potters succeeded in producing "white gold" – hard, translucent porcelain. It was so coveted that in Europe it was considered magical for centuries, until Böttger "reinvented" the secret in 1708.'
      },
      {
        g: 'ostasien', n: 'Gunpowder', y: 850, c: 'Physics & Tech', reach: 22, dur: 18, mult: 16, qual: 10, cbrk: 36, imm: 26, shk: 28, inv: 'Taoist Alchemists', org: 'China',
        dsc: 'Gunpowder discovered in the 9th century.',
        imp: 'Changed warfare worldwide. Also for mining and explosives.',
        ctx: 'Taoist monks were actually looking for an elixir of immortality when they mixed saltpeter, sulfur, and charcoal. Instead of eternal life, they found an explosive substance, initially used for fireworks, but soon for "fire lances" and primitive bombs against the Mongols.'
      },
      {
        g: 'ostasien', n: 'Printing (Woodblock)', y: 868, c: 'Communication', reach: 17, dur: 20, mult: 20, qual: 14, cbrk: 30, imm: 18, shk: 16, inv: 'Bi Sheng et al.', org: 'China',
        dsc: 'Woodblock printing and movable type centuries before Gutenberg.',
        imp: 'Spread knowledge in China. Precursor to European printing.',
        ctx: 'Long before Gutenberg, Chinese craftsmen carved entire book pages into wooden blocks. The Diamond Sutra (868 AD) is the world\'s oldest printed book. Later, Bi Sheng developed movable type from ceramics, but due to thousands of Chinese characters, it did not initially catch on.'
      },
      {
        g: 'ostasien', n: 'Compass', y: 1044, c: 'Physics & Tech', reach: 22, dur: 18, mult: 20, qual: 13, cbrk: 32, imm: 22, shk: 20, inv: 'Unknown', org: 'China',
        dsc: 'Magnetic compass – via Arab traders to Europe.',
        imp: 'Enabled high-seas navigation, Age of Discovery, and global sea trade.',
        ctx: 'Chinese diviners initially used "spoons" made of lodestone for Feng Shui, not navigation. Only in the Song Dynasty was the benefit for shipping realized. Needles were magnetized and floated – the key to the open sea.'
      },
      // NAHER OSTEN
      {
        g: 'nahost', n: 'Distillation', y: 800, c: 'Physics & Tech', reach: 18, dur: 20, mult: 16, qual: 12, cbrk: 28, imm: 18, shk: 16, inv: 'Jabir ibn Hayyan', org: 'Iraq',
        dsc: 'Arab alchemists perfected distillation.',
        imp: 'Basis for alcohol, perfume, medicines, and organic chemistry.',
        ctx: 'Alchemist Jabir ibn Hayyan (Geber) improved the alembic to purify substances. He sought the transmutation of metals but laid the foundation for modern chemistry (alcohol, acids), perfume making, and pharmacy.'
      },
      {
        g: 'nahost', n: 'Algebra', y: 820, c: 'Math', reach: 24, dur: 25, mult: 28, qual: 17, cbrk: 36, imm: 16, shk: 22, inv: 'Al-Khwarizmi', org: 'Iraq/Bagdad',
        dsc: 'Al-Khwarizmi established algebra as a distinct discipline.',
        imp: 'No physics, engineering, or computer science without algebra.',
        ctx: 'In the House of Wisdom in Baghdad, Al-Khwarizmi wrote his book "al-Jabr". He solved quadratic equations not just geometrically but abstractly. His name (Latinized: Algoritmi) is the origin of the word "Algorithm" – the basis of today\'s digital world.'
      },
      {
        g: 'nahost', n: 'Surgery (al-Zahrawi)', y: 1000, c: 'Medicine', reach: 19, dur: 22, mult: 18, qual: 18, cbrk: 28, imm: 24, shk: 18, inv: 'Al-Zahrawi', org: 'Spain/Córdoba',
        dsc: 'Al-Zahrawi\'s illustrated surgery book – the first of its kind.',
        imp: 'Many instruments still in use today. Basis of European surgery.',
        ctx: 'Al-Zahrawi (Abulcasis) was the court physician in the Caliphate of Córdoba. He invented over 200 surgical instruments, including scalpels, bone saws, and forceps, and was the first to describe using absorbable catgut for internal sutures – a technique still used today.'
      },
      {
        g: 'nahost', n: 'Coffee', y: 1000, c: 'Economy', reach: 18, dur: 18, mult: 10, qual: 11, cbrk: 14, imm: 16, shk: 12, inv: 'Unknown', org: 'Ethiopia/Yemen',
        dsc: 'Arab culture discovered and spread coffee from the 10th century.',
        imp: 'Global industry, coffee houses as intellectual hubs.',
        ctx: 'Sufi monks in Yemen used the brew from coffee cherries to stay awake for night prayers. From there, the drink spread via Mecca and Cairo to the world. Coffee houses became places of intellectual exchange, later fueling the European Enlightenment.'
      },
      {
        g: 'nahost', n: 'Optics (Ibn al-Haytham)', y: 1011, c: 'Physics & Tech', reach: 21, dur: 24, mult: 24, qual: 14, cbrk: 34, imm: 14, shk: 22, inv: 'Ibn al-Haytham', org: 'Egypt/Iraq',
        dsc: 'Ibn al-Haytham\'s "Book of Optics" founded the experimental method.',
        imp: 'Basis for glasses, telescopes, microscopes, cameras.',
        ctx: 'Under house arrest in Cairo, Ibn al-Haytham proved experimentally that light does not emit from the eye (as Greeks thought) but enters it. He researched lenses, mirrors, and the Camera Obscura and is considered one of the first true scientists due to his systematic approach.'
      },

      // SÜDASIEN
      {
        g: 'suedasien', n: 'Cotton (Textile)', y: -3000, c: 'Economy', reach: 20, dur: 22, mult: 12, qual: 14, cbrk: 20, imm: 18, shk: 12, inv: 'Indus Civilization', org: 'Pakistan/India',
        dsc: 'Indus Valley Civilization cultivated cotton 5000 years ago.',
        imp: 'Basis of global textile industry. Shaped early industrialization.',
        ctx: 'While others wore skins, linen, or wool, farmers in the Indus Valley domesticated the cotton plant. They developed spinning and weaving techniques producing fabrics that Greeks later described in amazement as "wool growing on trees".'
      },
      {
        g: 'suedasien', n: 'Medicine (Ayurveda)', y: -1500, c: 'Medicine', reach: 14, dur: 18, mult: 10, qual: 12, cbrk: 22, imm: 18, shk: 14, inv: 'Vedic Authors', org: 'India',
        dsc: 'Vedic texts describe Ayurveda as a comprehensive medical system.',
        imp: 'Influenced early Islamic medicine; Yoga now a global health practice.',
        ctx: 'Ayurveda ("Knowledge of Life") is one of the oldest holistic medical systems. The Charaka Samhita and Sushruta Samhita texts describe complex surgical procedures (like nose reconstruction) early on, and a doctrine of three Doshas prioritizing prevention over cure.'
      },
      {
        g: 'suedasien', n: 'Decimal System', y: 500, c: 'Math', reach: 25, dur: 25, mult: 28, qual: 17, cbrk: 38, imm: 14, shk: 20, inv: 'Aryabhata et al.', org: 'India',
        dsc: 'Indian mathematicians developed the decimal system with place value.',
        imp: 'No modern science, technology, or economy without the decimal system.',
        ctx: 'The ingenious concept that the value of a digit depends on its position (ones, tens, hundreds) originated in India. It dramatically simplified calculations compared to the Roman system and reached Europe via Arab scholars.'
      },
      {
        g: 'suedasien', n: 'Zero', y: 628, c: 'Math', reach: 25, dur: 25, mult: 30, qual: 18, cbrk: 40, imm: 12, shk: 24, inv: 'Brahmagupta', org: 'India',
        dsc: 'Brahmagupta defined zero as a full number in 628 AD.',
        imp: 'Basis of all modern mathematics and binary code.',
        ctx: 'What was "nothing" and philosophically unthinkable to the Greeks, Indian thinkers (Shunya) defined as a mathematical quantity. Brahmagupta formulated calculation rules for zero ("zero minus zero is zero"), enabling abstract mathematics and later the binary logic of computers.'
      },
      // EUROPE
      {
        g: 'europa', n: 'Printing Press', y: 1440, c: 'Communication', reach: 22, dur: 24, mult: 28, qual: 16, cbrk: 34, imm: 20, shk: 28, inv: 'Johannes Gutenberg', org: 'Germany',
        dsc: 'Gutenberg\'s printing press (1440) enabled mass reproduction of texts.',
        imp: 'Enabled Reformation, Enlightenment, and Scientific Revolution.',
        ctx: 'Gutenberg combined a wine press with movable type. Technically, Koreans (Jikji, 1377) and Chinese were ahead of him, but Gutenberg\'s system of hand casting instruments for letters and oil-based ink allowed for *economical* mass production for the first time, revolutionizing Europe\'s social structure.'
      },
      {
        g: 'europa', n: 'Steam Engine', y: 1769, c: 'Physics & Tech', reach: 24, dur: 22, mult: 28, qual: 18, cbrk: 30, imm: 28, shk: 22, inv: 'James Watt', org: 'Scotland',
        dsc: 'Watt\'s steam engine (1769) powered the Industrial Revolution.',
        imp: 'Factory production, railways, steamships. Transformation of work and global economy.',
        ctx: 'Thomas Newcomen built the first atmospheric steam engine for mining in 1712. However, it was enormously inefficient. James Watt\'s decisive contribution was the separate condenser, minimizing energy loss and making the engine powerful enough to drive factories.'
      },
      {
        g: 'europa', n: 'Railway', y: 1804, c: 'Infrastructure', reach: 23, dur: 21, mult: 24, qual: 17, cbrk: 26, imm: 28, shk: 20, inv: 'Stephenson / Trevithick', org: 'England',
        dsc: 'Steam railway connected continents and enabled mass transport.',
        imp: 'Drove industrialization and global trade. Compressed space and time.',
        ctx: 'Richard Trevithick built the first locomotive, but only George Stephenson\'s "Rocket" proved economic viability. The railway created time zones, national cohesion, and modern tourism. It made land transport faster than a galloping horse for the first time.'
      },
      {
        g: 'europa', n: 'Vaccination', y: 1796, c: 'Medicine', reach: 25, dur: 25, mult: 22, qual: 20, cbrk: 36, imm: 26, shk: 28, inv: 'Edward Jenner', org: 'England',
        dsc: 'Jenner\'s cowpox vaccine (1796) founded immunology.',
        imp: 'Saved hundreds of millions of lives. Eradicated smallpox. Basis of all vaccines.',
        ctx: 'The common knowledge that milkmaids did not get smallpox inspired Jenner. He infected a boy with harmless cowpox and later proved his immunity to deadly human smallpox. The term "vaccination" (from vacca: cow) recalls this origin.'
      },
      {
        g: 'europa', n: 'Telephone', y: 1876, c: 'Communication', reach: 23, dur: 18, mult: 20, qual: 16, cbrk: 28, imm: 24, shk: 22, inv: 'Alexander Graham Bell', org: 'USA/Scotland',
        dsc: 'Bell invented the telephone in 1876 – instantaneous voice communication.',
        imp: 'Basis of the modern telecommunications network.',
        ctx: 'The authorship is highly disputed. Antonio Meucci developed a "teletrofono" as early as 1854 but could not afford the patent. Elisha Gray filed his patent just 2 hours after Bell. Bell won the legal battle and went down in history as the inventor, although the basic idea already existed.'
      },
      {
        g: 'europa', n: 'Automobile', y: 1885, c: 'Physics & Tech', reach: 23, dur: 20, mult: 18, qual: 17, cbrk: 22, imm: 20, shk: 16, inv: 'Karl Benz', org: 'Germany',
        dsc: 'Benz\'s Patent-Motorwagen (1885) was the first practical gasoline vehicle.',
        imp: 'Created global mobility economy. Changed urban planning and society.',
        ctx: 'While Daimler built the engine, Karl Benz constructed the first integrated vehicle. His wife Bertha proved on the first long-distance trip (without his knowledge) that the "thing" worked – including repairing the fuel line with a hatpin.'
      },
      {
        g: 'europa', n: 'X-Rays', y: 1895, c: 'Medicine', reach: 22, dur: 23, mult: 18, qual: 18, cbrk: 32, imm: 26, shk: 22, inv: 'Wilhelm Röntgen', org: 'Germany',
        dsc: 'Röntgen discovered the rays named after him in 1895.',
        imp: 'Revolutionized diagnostics. Basis for CT, MRI, and medical imaging.',
        ctx: 'While experimenting with cathode ray tubes, Röntgen noticed a mysterious glow on a distant screen. He called the unknown radiation "X-rays". The first X-ray image showed his wife\'s hand – the first painless glimpse into the interior of a living human.'
      },
      {
        g: 'europa', n: 'Theory of Relativity', y: 1905, c: 'Physics & Tech', reach: 20, dur: 25, mult: 26, qual: 14, cbrk: 40, imm: 8, shk: 30, inv: 'Albert Einstein', org: 'Germany',
        dsc: 'Einstein united space and time, formulated E=mc².',
        imp: 'Basis for GPS, nuclear energy, laser technology, and modern cosmology.',
        ctx: 'As a patent clerk, Einstein thought about what happens if you fly alongside a beam of light. His theory toppled the Newtonian worldview: time is not absolute, mass is energy. Without considering time dilation, today\'s GPS would be wrong by 10 km per day.'
      },
      {
        g: 'europa', n: 'Photography', y: 1839, c: 'Communication', reach: 23, dur: 22, mult: 25, qual: 16, cbrk: 30, imm: 20, shk: 18, inv: 'Daguerre / Talbot', org: 'France/UK',
        dsc: 'Daguerreotype (1839) made the world visually preservable.',
        imp: 'Revolutionized art, science, journalism, and human memory.',
        ctx: 'After Niépce\'s first attempts, Daguerre perfected the process with silver-plated copper plates. Almost simultaneously, Talbot developed the negative-positive process, which enabled reproduction. Suddenly, reality could be frozen and preserved for generations.'
      },
      {
        g: 'europa', n: 'Anesthesia', y: 1846, c: 'Medicine', reach: 25, dur: 25, mult: 18, qual: 20, cbrk: 34, imm: 30, shk: 24, inv: 'Morton / Wells', org: 'USA',
        dsc: 'First public ether anesthesia (1846).',
        imp: 'Enabled painless surgeries and thus modern surgery. One of the greatest humanitarian advances.',
        ctx: 'Before 1846, surgery meant agony and shock. Dentist William Morton publicy demonstrated the effect of diethyl ether in the "Ether Dome" in Boston. The patient woke up and said: "Gentlemen, this is no humbug." This ended the age of pain in the OR.'
      },
      {
        g: 'europa', n: 'Power Grid / Light Bulb', y: 1879, c: 'Infrastructure', reach: 25, dur: 25, mult: 30, qual: 20, cbrk: 32, imm: 28, shk: 26, inv: 'Edison et al.', org: 'USA (System)',
        dsc: 'Edison developed the commercial light bulb and distribution systems in 1879.',
        imp: 'Extended the working day, basis of all electrical devices and modern industry.',
        ctx: 'The light bulb had many fathers (including Swan, Göbel), but they were short-lived. Edison bought patents, improved the filament and – crucially – created the commercial system of power grid and power plants. He was less the sole inventor than the entrepreneur who made light marketable.'
      },
      {
        g: 'europa', n: 'Nuclear Fission', y: 1938, c: 'Physics & Tech', reach: 24, dur: 22, mult: 25, qual: 10, cbrk: 40, imm: 14, shk: 30, inv: 'Hahn / Meitner', org: 'Germany',
        dsc: 'Hahn and Meitner discovered the fissionability of uranium atoms in 1938.',
        imp: 'Led to the atomic bomb (geopolitical order) and nuclear energy (low-CO2 energy).',
        ctx: 'Otto Hahn irradiated uranium with neutrons and surprisingly found barium. Lise Meitner, in Swedish exile, provided the physical explanation: The atomic nucleus had burst and released enormous energy (E=mc²). A discovery on the threshold of World War II that changed geopolitics forever.'
      },
      {
        g: 'europa', n: 'Penicillin', y: 1928, c: 'Medicine', reach: 24, dur: 23, mult: 20, qual: 20, cbrk: 28, imm: 26, shk: 20, inv: 'Alexander Fleming', org: 'Scotland',
        dsc: 'Fleming\'s penicillin discovery (1928) founded the antibiotic era.',
        imp: 'Made deadly infections curable. Saved over 200 million people.',
        ctx: 'A lucky coincidence: Fleming forgot a petri dish with bacteria, on which a mold grew that killed the bacteria. It took years for Florey and Chain to isolate the active ingredient and produce it en masse – just in time to save millions of soldiers\' lives in World War II.'
      },
      {
        g: 'europa', n: 'World Wide Web', y: 1991, c: 'Communication', reach: 25, dur: 22, mult: 29, qual: 20, cbrk: 22, imm: 24, shk: 18, inv: 'Tim Berners-Lee', org: 'CERN, Switzerland',
        dsc: 'Berners-Lee invented the Web in 1991 as a universal information system.',
        imp: 'Changed communication, economy, science, and culture worldwide.',
        ctx: 'Berners-Lee actually only wanted to organize the information chaos at CERN. He combined hypertext with the Internet. His most important decision: He did not patent the WWW but gave it to the world, which enabled its explosive spread and the democratization of knowledge.'
      },

      // AMERICAS
      {
        g: 'amerika', n: 'Corn (Domestication)', y: -7000, c: 'Economy', reach: 22, dur: 25, mult: 14, qual: 16, cbrk: 26, imm: 22, shk: 14, inv: 'Mesoamerican Farmers', org: 'Mexico',
        dsc: 'Mesoamerican cultures domesticated corn (~7000 BC).',
        imp: 'Global spread after 1492. One of the three most produced crops.',
        ctx: 'From the inconspicuous wild grass teosinte, farmers in Mexico bred corn over millennia. This genetic masterpiece formed the nutritional basis of the Maya and Aztecs and is today, whether as food or biofuel, the most grown plant in the world.'
      },
      {
        g: 'amerika', n: 'Airplane', y: 1903, c: 'Infrastructure', reach: 24, dur: 22, mult: 20, qual: 18, cbrk: 30, imm: 22, shk: 26, inv: 'Wright Brothers', org: 'USA',
        dsc: 'The Wright brothers realized the first controlled powered flight in 1903.',
        imp: 'Created global air traffic, changed war, trade, and tourism.',
        ctx: 'Orville and Wilbur Wright, bicycle mechanics from Ohio, solved the problem of controlled flight not with stronger engines, but through aerodynamics (wing warping). Their first flight in Kitty Hawk lasted only 12 seconds but freed humans from earthbound existence.'
      },
      {
        g: 'amerika', n: 'Microchip / Computer', y: 1947, c: 'Physics & Tech', reach: 25, dur: 23, mult: 30, qual: 20, cbrk: 26, imm: 16, shk: 20, inv: 'Bell Labs / Von Neumann', org: 'USA',
        dsc: 'Transistor (1947) and microprocessor – basis of the digital revolution.',
        imp: 'No internet, no space travel, no modern medicine without computers.',
        ctx: 'While the USA (ENIAC) and UK (Colossus) are often in focus, Konrad Zuse in Berlin already built the Z3 – the world\'s first functional, programmable computer – in 1941. However, the later invention of the transistor at Bell Labs and the Von Neumann architecture made computers scalable.'
      },
      {
        g: 'amerika', n: 'DNA Structure', y: 1953, c: 'Medicine', reach: 22, dur: 25, mult: 26, qual: 19, cbrk: 38, imm: 10, shk: 28, inv: 'Watson, Crick, Franklin', org: 'UK/USA',
        dsc: 'Discovery of the double helix (1953) revolutionized biology and medicine.',
        imp: 'Basis for genetics, gene therapy, forensics, biotechnology, and mRNA vaccines.',
        ctx: 'Based on the crucial X-ray images by Rosalind Franklin, Watson and Crick deciphered the structure of life. The realization that DNA stores information in a 4-letter code made biology an information science.'
      },
      {
        g: 'amerika', n: 'Internet (ARPANET)', y: 1969, c: 'Communication', reach: 25, dur: 23, mult: 30, qual: 20, cbrk: 24, imm: 14, shk: 18, inv: 'DARPA / UCLA', org: 'USA',
        dsc: 'ARPANET (1969) – technical basis of digital networking.',
        imp: 'Basis of the Internet. Changed communication and economy globally.',
        ctx: 'Elements of the Cold War, the US military sought a decentralized network that would work even if individual nodes failed. The first message "LO" (actually "LOGIN", but the system crashed) between two universities in California was the inconspicuous starting signal for the global web.'
      },
      {
        g: 'amerika', n: 'Spaceflight / GPS', y: 1969, c: 'Physics & Tech', reach: 21, dur: 20, mult: 20, qual: 16, cbrk: 28, imm: 22, shk: 24, inv: 'NASA', org: 'USA',
        dsc: 'Apollo Program (1969) – Humans on the Moon.',
        imp: 'GPS, communication satellites, new materials from space research.',
        ctx: 'The "Sputnik shock" triggered a technological arms race that culminated in the moon landing in 1969. Besides prestige, space travel yielded practical by-products: satellite navigation (GPS), weather satellites, and worldwide TV transmissions.'
      },
      {
        g: 'amerika', n: 'Smartphone', y: 2007, c: 'Communication', reach: 25, dur: 20, mult: 28, qual: 19, cbrk: 18, imm: 28, shk: 22, inv: 'Apple (Jobs) et al.', org: 'USA',
        dsc: 'iPhone (2007) combined phone, computer, and internet in the pocket.',
        imp: 'Changed social interaction, economy, and information access for billions.',
        ctx: 'Steve Jobs presented three devices in one in 2007: "A widescreen iPod, a revolutionary mobile phone, and a breakthrough internet communicator." With the introduction of the App Store, the smartphone became the universal tool for almost every human activity.'
      },
      {
        g: 'amerika', n: 'Artificial Intelligence', y: 2022, c: 'Physics & Tech', reach: 25, dur: 25, mult: 30, qual: 15, cbrk: 30, imm: 30, shk: 28, inv: 'OpenAI / Google et al.', org: 'USA/Global',
        dsc: 'Breakthrough of generative AI (ChatGPT et al.) marks the beginning of the AI age.',
        imp: 'Potential to fundamentally change all knowledge work, research, and creativity. Effects still open.',
        ctx: 'For decades, AI was an academic niche field. Through the combination of massive amounts of data and massive computing power, neural networks (transformer models) suddenly learned to understand and generate human language. This marks the transition from tools that execute commands to tools that think along.'
      }
    ];



    // ══════════════════════════════════════
    // DATASETS CONFIG
    // ══════════════════════════════════════
    const DATASETS = {
      inv: {
        data: INV,
        lbl: 'Inventions',
        cats: ['Medicine', 'Physics & Tech', 'Math', 'Communication', 'Economy', 'Infrastructure'],
        chips: [
          { id: 'Medicine', l: '◈ Medicine' },
          { id: 'Physics & Tech', l: '◈ Physics & Tech' },
          { id: 'Math', l: '◈ Math' },
          { id: 'Communication', l: '◈ Communication' },
          { id: 'Economy', l: '◈ Economy' },
          { id: 'Infrastructure', l: '◈ Infrastructure' }
        ],
        scoreA_lbl: 'Societal Impact',
        scoreB_lbl: 'Revolutionary',
        meth: {
          A: [
            { t: '🌍 Reach', d: 'Local to Global', max: 25 },
            { t: '⏳ Durability', d: 'Decades to Millennia', max: 25 },
            { t: '🔗 Multiplier', d: 'Follow-up Innovations', max: 30 },
            { t: '🏥 Quality of Life', d: 'Daily Life Improvement', max: 20 }
          ],
          B: [
            { t: '🧠 Concept Break', d: 'Surprise Effect', max: 40 },
            { t: '⚡ Instant Impact', d: 'Speed of Adoption', max: 30 },
            { t: '🌐 Societal Shock', d: 'Change of Order', max: 30 }
          ]
        }
      },
      nobel: {
        data: typeof NOBEL !== 'undefined' ? NOBEL : [],
        lbl: 'Nobel Prizes',
        cats: ['Physics', 'Chemistry', 'Medicine', 'Peace', 'Literature', 'Economics'],
        chips: [
          { id: 'Physics', l: '◈ Physics' },
          { id: 'Chemistry', l: '◈ Chemistry' },
          { id: 'Medicine', l: '◈ Medicine' },
          { id: 'Peace', l: '◈ Peace' },
          { id: 'Literature', l: '◈ Literature' },
          { id: 'Economics', l: '◈ Economics' }
        ],
        scoreA_lbl: 'Positive Impact',
        scoreB_lbl: 'Disruption Factor',
        meth: {
          A: [
            { t: '🌍 Global Reach', d: 'International Recognition', max: 25 },
            { t: '⏳ Lasting Legacy', d: 'Enduring Relevance', max: 25 },
            { t: '🔗 Scientific Multiplier', d: 'Basis for new fields', max: 30 },
            { t: '🏥 Human Benefit', d: 'Saving lives / Peace', max: 20 }
          ],
          B: [
            { t: '🧠 Paradigm Shift', d: 'Changing how we think', max: 40 },
            { t: '⚡ Immediate Effect', d: 'Rapid implementation', max: 30 },
            { t: '🌐 Cultural Impact', d: 'Global Awareness', max: 30 }
          ]
        }
      }
    };

    // ══════════════════════════════════════
    // STATE
    // ══════════════════════════════════════
    let DATASET = 'inv';
    let VIEW = 'grouped';
    let SORT = 'score';
    let CATS = new Set(['all']);
    let MIN_SCORE_VAL = 0;
    let MAX_SCORE_VAL = 100;
    let LEG_MODE = 'total'; // 'total' or 'avg'

    // SCORING
    const scoreA = i => i.reach + i.dur + i.mult + i.qual;
    const scoreB = i => i.cbrk + i.imm + i.shk;
    const calcScore = i => VIEW === 'revolution' ? scoreB(i) : scoreA(i);
    const maxSc = 100;
    const fmtY = y => y < 0 ? `${Math.abs(y)} BC` : `${y} AD`;

    // DATA HELPERS
    const getDatasetData = () => DATASETS[DATASET].data;

    // UPDATE CHIPS
    function updateCategoryChips() {
      const cCont = document.getElementById('chips');
      const conf = DATASETS[DATASET];
      cCont.innerHTML = `<button class="ch ${CATS.has('all') ? 'on' : ''}" data-c="all">All</button>` +
        conf.chips.map(c => `<button class="ch ${CATS.has(c.id) ? 'on' : ''}" data-c="${c.id}">${c.l}</button>`).join('');
    }

    // UPDATE METHODOLOGY
    function updateMethodology() {
      const d = DATASETS[DATASET].meth;
      const mA = d.A.map(m => `
        <div class="meth-dim">
          <div class="meth-dim-t">${m.t} (max ${m.max})</div>
          <p>${m.d}</p>
        </div>
      `).join('');
      const mB = d.B.map(m => `
        <div class="meth-dim">
          <div class="meth-dim-t">${m.t} (max ${m.max})</div>
          <p>${m.d}</p>
        </div>
      `).join('');

      const inner = `
        <div class="meth-group-title">Score A – ${DATASETS[DATASET].scoreA_lbl}</div>
        ${mA}
        <div class="meth-group-title">Score B – ${DATASETS[DATASET].scoreB_lbl}</div>
        ${mB}
        <div class="meth-note">Methodology adapted for ${DATASETS[DATASET].lbl}.</div>
      `;
      document.querySelector('.meth-inner').innerHTML = inner;
    }

    // Filtering Logic: group + range + category
    const getFilteredItems = gid => getDatasetData()
      .filter(i => {
        const sc = calcScore(i);
        // Filter by Group
        if (i.g !== gid) return false;
        // Filter by Score Range
        if (sc < MIN_SCORE_VAL || sc > MAX_SCORE_VAL) return false;
        // Filter by Category
        if (!CATS.has('all') && !CATS.has(i.c)) return false;
        return true;
      })
      .sort((a, b) => a.y - b.y);

    const gTot = gid => getFilteredItems(gid).reduce((s, i) => s + calcScore(i), 0);
    const maxTot = () => Math.max(...GRP.map(g => gTot(g.id)), 1); // Avoid div/0

    // SORTING (Grouped View)
    function sortedGrp() {
      // Create a shallow copy to sort
      return [...GRP].sort((a, b) => {
        if (SORT === 'score') return gTot(b.id) - gTot(a.id);
        if (SORT === 'count') return getFilteredItems(b.id).length - getFilteredItems(a.id).length;
        if (SORT === 'alpha') return a.name.localeCompare(b.name);
        if (SORT === 'oldest') {
          const f = id => {
            const arr = getFilteredItems(id);
            return arr.length ? Math.min(...arr.map(i => i.y)) : 9999;
          };
          return f(a.id) - f(b.id);
        }
        return 0;
      });
    }

    function shadeCol(hex, idx, total) {
      const t = total <= 1 ? 0.78 : 0.50 + 0.50 * (idx / (total - 1));
      const n = parseInt(hex.replace('#', ''), 16);
      const r = Math.min(255, Math.round(((n >> 16) & 0xff) * t));
      const g = Math.min(255, Math.round(((n >> 8) & 0xff) * t));
      const b = Math.min(255, Math.round((n & 0xff) * t));
      return `rgb(${r},${g},${b})`;
    }

    // ══════════════════════════════════════
    // MEASURE
    // Returns { chartH, plotW } based on current DOM
    // ══════════════════════════════════════
    function measure() {
      const shell = document.getElementById('shell');
      if (!shell) return { chartH: 300, plotW: 600 };
      const shellH = shell.clientHeight;
      // x-strip height ~ 30px, top padding 0.85rem~13px
      const chartH = Math.max(120, shellH - 44);
      // plotW measured from cBody width minus y-col(40px) + paddings(2.5rem+0.9rem = ~54px)
      const bodyW = document.getElementById('cBody').clientWidth || shell.clientWidth;
      const plotW = Math.max(100, bodyW - 40 - 54);
      return { chartH, plotW };
    }

    // ══════════════════════════════════════
    // TOOLTIP
    // ══════════════════════════════════════
    const TT = document.getElementById('tt');
    function showTT(e, inv, col) {
      const g = GM[inv.g];
      const sc = calcScore(inv);
      document.getElementById('ttYr').textContent = fmtY(inv.y);
      document.getElementById('ttNm').textContent = inv.n;
      document.getElementById('ttGrp').innerHTML = `<span style="color:${g.col}">● ${g.name}</span>`;
      document.getElementById('ttCat').textContent = '📁 ' + inv.c;
      document.getElementById('ttDsc').textContent = inv.dsc;
      document.getElementById('ttRl').textContent = VIEW === 'revolution' ? 'Score B' : 'Score A';
      document.getElementById('ttRf').style.cssText = `width:${sc}%;background:${col};`;
      document.getElementById('ttRn').textContent = sc;
      TT.classList.add('on');
      posTT(e);
    }
    function posTT(e) {
      const W = 275, H = 190;
      let x = e.clientX + 14, y = e.clientY - 18;
      if (x + W > window.innerWidth - 4) x = e.clientX - W - 14;
      if (y + H > window.innerHeight - 4) y = e.clientY - H - 4;
      TT.style.left = x + 'px'; TT.style.top = y + 'px';
    }
    function hideTT() { TT.classList.remove('on'); }

    // ══════════════════════════════════════
    // MODAL
    // ══════════════════════════════════════
    function openModal(inv, col) {
      const g = GM[inv.g];
      document.getElementById('mCat').textContent = inv.c;
      document.getElementById('mH').textContent = inv.n;
      document.getElementById('mMeta').innerHTML =
        `<span>📅 ${fmtY(inv.y)}</span><span>👤 ${inv.inv}</span><span>📍 ${inv.org}</span><span style="color:${g.col}">● ${g.name}</span>`;
      document.getElementById('mImp').textContent = inv.imp;
      document.getElementById('mCtx').textContent = inv.ctx || 'Context loading...';
      document.getElementById('mBody').textContent = inv.dsc;
      let dims, lbl;
      const conf = DATASETS[DATASET];
      const meth = conf.meth;

      if (VIEW === 'revolution') {
        lbl = `Score B – ${conf.scoreB_lbl}`;
        dims = meth.B.map((m, i) => {
          // Mapping values to dims based on index is brittle, but efficient for this 1-file setup
          // Order: cbrk, imm, shk
          const val = i === 0 ? inv.cbrk : i === 1 ? inv.imm : inv.shk;
          return { l: `${m.t} (max ${m.max})`, v: val, m: m.max };
        });
      } else {
        lbl = `Score A – ${conf.scoreA_lbl}`;
        dims = meth.A.map((m, i) => {
          // Order: reach, dur, mult, qual
          const val = i === 0 ? inv.reach : i === 1 ? inv.dur : i === 2 ? inv.mult : inv.qual;
          return { l: `${m.t} (max ${m.max})`, v: val, m: m.max };
        });
      }

      document.getElementById('mTotL').textContent = lbl;
      document.getElementById('mTot').textContent = calcScore(inv) + ' / 100';
      document.getElementById('mRows').innerHTML = dims.map(d => `
    <div class="m-row">
      <span class="m-rl">${d.l}</span>
      <div class="m-rb"><div class="m-rf" style="width:${(d.v / d.m) * 100}%;background:${col};"></div></div>
      <span class="m-rn">${d.v}/${d.m}</span>
    </div>`).join('');
      document.getElementById('modalBg').classList.add('on');
    }
    document.getElementById('modalX').addEventListener('click', () => document.getElementById('modalBg').classList.remove('on'));
    document.getElementById('modalBg').addEventListener('click', e => {
      if (e.target === document.getElementById('modalBg')) document.getElementById('modalBg').classList.remove('on');
    });

    // ══════════════════════════════════════
    // BUILD AXES
    // ══════════════════════════════════════
    function buildYcol(el, maxV, h) {
      let s = '';
      for (let i = 0; i <= 5; i++) {
        const b = i / 5 * h;
        s += `<div class="ytick" style="bottom:${b}px"><span class="ytick-lbl">${Math.round(maxV * i / 5)}</span><div class="ytick-mk"></div></div>`;
      }
      el.style.height = h + 'px';
      el.innerHTML = s;
    }
    function buildHgrid(el, h) {
      let s = '';
      for (let i = 1; i <= 5; i++) s += `<div class="hgl" style="bottom:${i / 5 * h}px"></div>`;
      el.innerHTML += s;
    }

    // ══════════════════════════════════════
    // RENDER GROUPED
    // ══════════════════════════════════════
    function renderGrouped(sg) {
      const { chartH } = measure();
      const cBody = document.getElementById('cBody');
      const xStrip = document.getElementById('xStrip');
      cBody.innerHTML = ''; xStrip.innerHTML = '';

      document.getElementById('yLbl').textContent =
        VIEW === 'revolution' ? `${DATASETS[DATASET].scoreB_lbl} (cumulative)` : `${DATASETS[DATASET].scoreA_lbl} (cumulative)`;

      // C-layout
      const layout = document.createElement('div');
      layout.className = 'c-layout';

      const yCol = document.createElement('div');
      yCol.className = 'y-col';
      buildYcol(yCol, maxTot(), chartH);

      const plot = document.createElement('div');
      plot.className = 'plot';
      plot.style.height = chartH + 'px';
      buildHgrid(plot, chartH);
      const base = document.createElement('div'); base.className = 'base'; plot.appendChild(base);

      // bars
      const barsWrap = document.createElement('div'); barsWrap.className = 'bars';
      sg.forEach(g => {
        const invs = getFilteredItems(g.id);
        const tot = invs.reduce((s, i) => s + calcScore(i), 0);
        const stackPx = tot > 0 ? Math.round((tot / maxTot()) * chartH) : 0;

        const bg = document.createElement('div'); bg.className = 'bgrp';
        const st = document.createElement('div'); st.className = 'bstk'; st.style.height = stackPx + 'px';
        invs.forEach((inv, idx) => {
          const sc = calcScore(inv);
          const segPx = tot > 0 ? Math.max(2, Math.round((sc / tot) * stackPx)) : 0;
          const seg = document.createElement('div'); seg.className = 'bseg';
          seg.style.height = segPx + 'px';
          seg.style.background = shadeCol(g.col, idx, invs.length);
          seg.addEventListener('mouseenter', e => showTT(e, inv, g.col));
          seg.addEventListener('mousemove', posTT);
          seg.addEventListener('mouseleave', hideTT);
          seg.addEventListener('click', () => { hideTT(); openModal(inv, g.col); });
          st.appendChild(seg);
        });
        bg.appendChild(st);
        barsWrap.appendChild(bg);
      });
      plot.appendChild(barsWrap);
      layout.appendChild(yCol);
      layout.appendChild(plot);
      cBody.appendChild(layout);

      // labels strip
      const gl = document.createElement('div'); gl.className = 'glabels';
      sg.forEach(g => {
        const invs = getFilteredItems(g.id);
        const tot = invs.reduce((s, i) => s + calcScore(i), 0);
        const lc = document.createElement('div'); lc.className = 'glbl';
        lc.innerHTML = `<div class="glbl-n">${g.name}</div><div class="glbl-m">${invs.length} items · ${tot} pts</div>`;
        gl.appendChild(lc);
      });
      xStrip.appendChild(gl);
    }

    // ══════════════════════════════════════
    // RENDER TIMELINE
    // ══════════════════════════════════════
    function renderTimeline(allInvs) {
      const cBody = document.getElementById('cBody');
      const xStrip = document.getElementById('xStrip');
      cBody.innerHTML = ''; xStrip.innerHTML = '';
      document.getElementById('yLbl').textContent = 'Item Score';

      if (!allInvs.length) {
        cBody.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;flex:1;color:var(--muted);">No items match the current filters.</div>';
        return;
      }

      // ── Build skeleton to measure actual plot width ──
      const layout = document.createElement('div'); layout.className = 'c-layout';
      const yCol = document.createElement('div'); yCol.className = 'y-col';
      const plot = document.createElement('div'); plot.className = 'plot'; plot.style.overflow = 'hidden';
      layout.appendChild(yCol); layout.appendChild(plot);
      cBody.appendChild(layout);

      // Force layout so getBoundingClientRect works
      const plotW = plot.getBoundingClientRect().width;
      const { chartH } = measure();

      // Size everything now that we know plotW
      const N = allInvs.length, GAP = 3;
      const BAR_W = Math.max(5, Math.floor((plotW - (N - 1) * GAP) / N));
      const maxSc = Math.max(...allInvs.map(i => calcScore(i)), 1);

      buildYcol(yCol, maxSc, chartH);
      plot.style.height = chartH + 'px';
      buildHgrid(plot, chartH);
      const base = document.createElement('div'); base.className = 'base'; plot.appendChild(base);

      const canvas = document.createElement('div');
      canvas.className = 'tl-canvas';
      canvas.style.width = (N * BAR_W + (N - 1) * GAP) + 'px';
      canvas.style.height = chartH + 'px';

      // Era lines
      const eras = [-10000, -5000, -3000, -1000, 0, 500, 1000, 1500, 1750, 1850, 1900, 1950, 2000];
      eras.forEach(ey => {
        let ci = 0, cd = Infinity;
        allInvs.forEach((inv, idx) => { const d = Math.abs(inv.y - ey); if (d < cd) { cd = d; ci = idx; } });
        if (cd > 500) return;
        const xc = ci * (BAR_W + GAP) + BAR_W / 2;
        const el = document.createElement('div'); el.className = 'tl-era'; el.style.left = xc + 'px'; canvas.appendChild(el);
        const lb = document.createElement('div'); lb.className = 'tl-era-l'; lb.style.left = xc + 'px'; lb.style.bottom = '4px';
        lb.textContent = ey < 0 ? Math.abs(ey) + 'v' : ey === 0 ? '0' : String(ey); canvas.appendChild(lb);
      });

      // Bars
      allInvs.forEach((inv, idx) => {
        const sc = calcScore(inv), bh = Math.max(4, Math.round((sc / maxSc) * chartH));
        const g = GM[inv.g];
        const bar = document.createElement('div'); bar.className = 'tl-bar';
        bar.style.cssText = `left:${idx * (BAR_W + GAP)}px;width:${BAR_W}px;height:${bh}px;background:${g.col};opacity:0.86;`;
        bar.addEventListener('mouseenter', e => showTT(e, inv, g.col));
        bar.addEventListener('mousemove', posTT);
        bar.addEventListener('mouseleave', hideTT);
        bar.addEventListener('click', () => { hideTT(); openModal(inv, g.col); });
        canvas.appendChild(bar);
      });

      plot.appendChild(canvas);

      // x-strip info
      const inf = document.createElement('div'); inf.className = 'tlinfo';
      const term = DATASET === 'nobel' ? 'Prizes' : 'Inventions';
      inf.innerHTML = `← ${fmtY(allInvs[0].y)} &ensp;·&ensp; ${fmtY(allInvs[N - 1].y)} →&ensp;&ensp;Color = Culture Group &ensp;·&ensp; Height = Score &ensp;·&ensp; ${N} ${term} displayed`;
      xStrip.appendChild(inf);
    }

    // ══════════════════════════════════════
    // RENDER MAIN
    // ══════════════════════════════════════
    function render() {
      // Timeline Logic Update: also respect min/max
      if (VIEW === 'timeline') {
        const allInvs = getDatasetData()
          .filter(i => {
            const sc = calcScore(i);
            if (sc < MIN_SCORE_VAL || sc > MAX_SCORE_VAL) return false;
            if (!CATS.has('all') && !CATS.has(i.c)) return false;
            return true;
          })
          .sort((a, b) => a.y - b.y);
        renderTimeline(allInvs);
      } else {
        const sg = sortedGrp();
        renderGrouped(sg);
      }
      updateLegend();
    }

    // ══════════════════════════════════════
    // VIEW DESCRIPTIONS
    // ══════════════════════════════════════
    const DESCS = {
      grouped: 'Bars = Culture Groups. Height = cumulative score. Hover = Info, Click = Details.',
      timeline: 'Chronological timeline. Each entity = one bar. Height = Score. Color = Culture Group.',
      revolution: 'Score B evaluates the break with existing paradigms and the immediate disruption of the status quo.',
    };

    // ══════════════════════════════════════
    // EVENTS
    // ══════════════════════════════════════
    // DYNAMIC LEGEND UPDATE
    function updateLegend() {
      const legGrid = document.getElementById('legGrid');

      // Calculate total and average for each group
      const groupsWithScore = GRP.map(g => {
        const items = getFilteredItems(g.id);
        const total = items.reduce((s, i) => s + calcScore(i), 0);
        const count = items.length;
        const avg = count > 0 ? Math.round(total / count * 10) / 10 : 0;
        return { ...g, totalScore: total, count, avg };
      });

      // Sort by selected mode
      if (LEG_MODE === 'avg') {
        groupsWithScore.sort((a, b) => b.avg - a.avg);
      } else {
        groupsWithScore.sort((a, b) => b.totalScore - a.totalScore);
      }

      const maxVal = Math.max(...groupsWithScore.map(g => LEG_MODE === 'avg' ? g.avg : g.totalScore), 1);

      legGrid.innerHTML = groupsWithScore.map(g => {
        const val = LEG_MODE === 'avg' ? g.avg : g.totalScore;
        const pct = maxVal > 0 ? (val / maxVal) * 100 : 0;
        const label = LEG_MODE === 'avg'
          ? `⌀ ${g.avg} · ${g.count}`
          : `${g.totalScore} · ${g.count}`;
        return `<div class="leg-row">
          <div class="leg-dot" style="background:${g.col}"></div>
          <span class="leg-name">${g.name}</span>
          <div class="leg-bar"><div class="leg-bar-f" style="width:${pct}%;background:${g.col}"></div></div>
          <span class="leg-pts">${label}</span>
        </div>`;
      }).join('');
    }

    // EVENT LISTENERS
    // Dataset switcher
    document.getElementById('dtabs').addEventListener('click', e => {
      const t = e.target.closest('.vt'); if (!t) return;
      if (t.dataset.d === DATASET) return;
      DATASET = t.dataset.d;
      document.querySelectorAll('#dtabs .vt').forEach(v => v.classList.toggle('on', v === t));
      CATS = new Set(['all']);
      updateCategoryChips();
      updateMethodology();
      render();
    });

    // View switcher
    document.getElementById('vtabs').addEventListener('click', e => {
      const t = e.target.closest('.vt'); if (!t) return;
      if (t.dataset.v === VIEW) return;
      VIEW = t.dataset.v;
      document.querySelectorAll('#vtabs .vt').forEach(v => v.classList.toggle('on', v === t));
      document.getElementById('sortSec').style.display = VIEW === 'timeline' ? 'none' : '';
      document.getElementById('vtDesc').textContent = DESCS[VIEW];
      updateMethodology();
      render();
    });

    // Score Range Inputs
    const minInp = document.getElementById('minScoreInp');
    const maxInp = document.getElementById('maxScoreInp');
    function updateRange() {
      let min = parseInt(minInp.value) || 0;
      let max = parseInt(maxInp.value) || 100;
      if (min < 0) min = 0;
      if (max > 100) max = 100;
      MIN_SCORE_VAL = min;
      MAX_SCORE_VAL = max;
      render();
    }
    minInp.addEventListener('input', updateRange);
    maxInp.addEventListener('input', updateRange);

    // Legend Mode
    document.getElementById('legMode').addEventListener('click', e => {
      const b = e.target.closest('.leg-btn'); if (!b) return;
      if (b.dataset.lm === LEG_MODE) return;
      LEG_MODE = b.dataset.lm;
      document.querySelectorAll('#legMode .leg-btn').forEach(btn => btn.classList.toggle('on', btn === b));
      updateLegend();
    });

    // Sort dropdown
    document.getElementById('sortSel').addEventListener('change', e => { SORT = e.target.value; render(); });

    document.getElementById('chips').addEventListener('click', e => {
      const b = e.target.closest('.ch'); if (!b) return;
      const cat = b.dataset.c;
      if (cat === 'all') { CATS = new Set(['all']); }
      else { CATS.delete('all'); CATS.has(cat) ? CATS.delete(cat) : CATS.add(cat); if (!CATS.size) CATS.add('all'); }
      document.querySelectorAll('#chips .ch').forEach(c => c.classList.toggle('on', CATS.has(c.dataset.c)));
      render();
    });


    document.getElementById('methHdr').addEventListener('click', function () {
      this.classList.toggle('on');
      document.getElementById('methBody').classList.toggle('on');
    });

    // ══════════════════════════════════════
    // RESIZE → RE-RENDER
    // ══════════════════════════════════════
    let resizeTimer = null;
    new ResizeObserver(() => {
      clearTimeout(resizeTimer);
      resizeTimer = setTimeout(render, 80);
    }).observe(document.getElementById('shell'));

    // ══════════════════════════════════════
    // INIT
    // ══════════════════════════════════════
    updateCategoryChips(); // Init chips
    updateMethodology(); // Init meth
    document.getElementById('vtDesc').textContent = DESCS['grouped'];
    render();
  </script>
</body>

</html>